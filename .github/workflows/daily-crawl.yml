name: Daily Contest Crawler

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ, í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ)ì— ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write
  actions: read

jobs:
  crawl-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run crawler
      run: |
        python src/main.py
        
    - name: Check if data exists
      id: check_data
      run: |
        if [ -f "data/contests.json" ] && [ -s "data/contests.json" ]; then
          echo "data_exists=true" >> $GITHUB_OUTPUT
          echo "contest_count=$(python -c "import json; data=json.load(open('data/contests.json')); print(len(data))")" >> $GITHUB_OUTPUT
        else
          echo "data_exists=false" >> $GITHUB_OUTPUT
          echo "contest_count=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Prepare email content
      if: steps.check_data.outputs.data_exists == 'true'
      run: |
        python -c "
import json
import os
from datetime import datetime

# JSON ë°ì´í„° ì½ê¸°
with open('data/contests.json', 'r', encoding='utf-8') as f:
    contests = json.load(f)

# ì´ë©”ì¼ ë‚´ìš© ìƒì„±
email_content = f'''
ğŸ“¢ ê³µëª¨ì „ í¬ë¡¤ë§ ê²°ê³¼ - {datetime.now().strftime('%Yë…„ %mì›” %dì¼')}

ì´ {len(contests)}ê°œì˜ ê³µëª¨ì „ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

ğŸ† ë°œê²¬ëœ ê³µëª¨ì „ ëª©ë¡:
'''

for i, contest in enumerate(contests, 1):
    email_content += f'''
{i}. {contest['title']}
   ğŸ”— ë§í¬: {contest['url']}
   ğŸ“ ì‚¬ì´íŠ¸: {contest['site']}
   
'''

email_content += '''
---
ì´ ë©”ì¼ì€ GitHub Actionsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
'''

# íŒŒì¼ë¡œ ì €ì¥
with open('email_content.txt', 'w', encoding='utf-8') as f:
    f.write(email_content)
"
        
    - name: Send email notification
      if: steps.check_data.outputs.data_exists == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸ¯ ê³µëª¨ì „ í¬ë¡¤ë§ ê²°ê³¼ (${{ steps.check_data.outputs.contest_count }}ê°œ ë°œê²¬)"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: file://email_content.txt
        
    - name: Upload artifacts
      if: steps.check_data.outputs.data_exists == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: contest-data-${{ github.run_number }}
        path: |
          data/contests.json
          data/contests.csv
        retention-days: 30
        
    - name: Commit and push results
      if: steps.check_data.outputs.data_exists == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/
        git commit -m "Update contest data - $(date +'%Y-%m-%d %H:%M:%S')" || exit 0
        git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git || exit 0